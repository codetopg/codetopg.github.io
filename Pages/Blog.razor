@page "/blog"
@using codeTopGBlazorWasm.ApiServices
@using codeTopGBlazorWasm.Models
@using codeTopGBlazorWasm.Components
@inject IHashNodeGqlApi hashNodeGql
@inject IJSRuntime jsRuntime

<PageTitle>My Blog</PageTitle>



@if (hashnodeData is null)
{
    <button @onclick="GetAllBlogPosts" class="btn btn-primary">Get Blog</button>
}

@if (spinner)
{
    <LoadingSpinnerSpin></LoadingSpinnerSpin>
}

@if (post is null)
{
    @if (hashnodeData is null)
    {
        <p> Try to get some</p>
    }

}
else
{
    <ModalComponent Show="readmore" OnClose="DialogCancelHandler">
        <Title>@post.data.post.title</Title>
        <Body>
            <div @ref=focusToTop></div>
            @((MarkupString)@post.data.post.content)
        </Body>
    </ModalComponent>
}



@*get posts for populated page*@
@if (hashnodeData is null)
{
    <p>Click the Get Blog button</p>
}
else
{
    @foreach (var item in hashnodeData.data.user.publication.posts)
    {
        <div class="container d-grid gap-3">
            <div class="row p-2 bg-light border">
                <div class="col-lg-3">
                    <img src="@item.coverImage.ToString()" class="img-fluid">
                </div>
                <div class="col-lg-9">
                    <div class="card-text p-2 bg-light border text-md-center fw-bold">
                        @item.title
                    </div>
                    <div class="card-body" @onclick=@(() => GetPost(item.slug))>
                        @item.brief
                        read more...
                    </div>
                </div>
            </div>
        </div>
    }
}


@code {
    private HashNodeModel? hashnodeData;
    private HashNodePostModel? post;
    private bool readmore = false;
    private bool spinner = false;
    ElementReference focusToTop;


    private void DialogCancelHandler(MouseEventArgs e)
    {
        readmore = false;
        post!.data.post.content = string.Empty;
    }
    private async Task FocusToTop()
    {
        await jsRuntime.InvokeVoidAsync("getHashNodeInterop.focusToTop", focusToTop);
    }

    private async Task GetPost(string slug)
    {
        spinner = true;
        readmore = true;
        post = await hashNodeGql.GetPost(slug);
        spinner = false;
        await FocusToTop();
        await Task.CompletedTask;
    }

    private async Task GetAllBlogPosts()
    {
        spinner = true;
        hashnodeData = await hashNodeGql.GetAllBlogPosts();
        spinner = false;
        await Task.CompletedTask;
    }

    public void Dispose()
    {
    }
}
